var	audio     = new Audio(),
	container = document.createElement('div'),
	credits   = document.createElement('div'),
	metronome = document.createElement('div'),

	block     = [],

	bpm       = 148.34,
	offset    = 6;

	message   = {
		title: 'html5, ftw.',
		text:  'and not a single .swf in sight'

	},
	
	pattern  = {
		0: {
			length: 8,
			0:  '00000000000',
		},

		0.5: {
			length: 44,

			0:  'fffffffffff',
			2:  'bbbbbbbbbbb',
			4:  '88888888888',
			6:  'fffffffffff',
			8:  'ccccccccccc',
			10: 'aaaaaaaaaaa',
			12: '88888888888',
			14: '66666666666',
			16: '44444444444',
			18: 'fffffffffff',
			20: 'bbbbbbbbbbb',
			22: '88888888888',
			24: 'fffffffffff',
			26: 'bbbbbbbbbbb',
			28: '88888888888',
			30: 'fffffffffff',
			32: 'ccccccccccc',
			34: 'aaaaaaaaaaa',
			36: '88888888888',
			38: '66666666666',
			40: '44444444444',
			42: 'fffffffffff',
			44: 'bbbbbbbbbbb',
		},

		0.6: {
			length: 24,

			0:  'ccccccccccc',
			2:  'fffffffffff',
			4:  'bbbbbbbbbbb',
			6:  '88888888888',
			8:  'fffffffffff',
			10: 'ccccccccccc',
			12: 'aaaaaaaaaaa',
			14: '88888888888',
			16: '66666666666',
			18: '44444444444',
			20: 'fffffffffff',
			22: 'bbbbbbbbbbb',
			23: '88888888888'
		},

		1: {
			length: 6,

			0:  'fffffffffff',
			2:  'bbbbbbbbbbb',
			4:  '88888888888',
			6:  '00000000000'
		},

		2: {
			length: 40,

			0:  'f0000000000',
			5:  '00f00000000',
			11: '000f0000000',
			16: '0000f000000',
			22: '0000000f000',
			27: '00000000f00',
			33: '000000000f0'
		},

		3: {
			length: 40,

			0:  '000000000f0',
			5:  '00000000f00',
			11: '0000000f000',
			16: '0000f000000',
			22: '000f0000000',
			27: '00f00000000',
			33: 'f0000000000',
			39: '00000000000'
		},

		4: {
			length: 23,

			0:  '0000000ffff',
			8:  '0000fff0000',
			13: 'ffff0000000',
			18: '0000fff0000'
		},

		5: {
			length: 40,

			0:  '00000000000',
			14: 'f0000000000',
			18: '00f00000000',
			22: '0000f000000',
			27: '0000000f000',
			33: '000000000f0',
			39: '00000000000',
		},

		6: {
			length: 24,

			0:  '00000000000',
			8:  'fffffffffff',
			10: 'ccccccccccc',
			12: 'aaaaaaaaaaa',
			14: '88888888888',
			16: '66666666666',
			18: '44444444444',
			20: 'fffffffffff',
			22: 'ccccccccccc',
			23: 'aaaaaaaaaaa'
		},

		7: {
			length: 18,

			2:  '88888888888',
			4:  '66666666666',
			6:  '44444444444',
			8:  'fffffffffff',
			10: 'ddddddddddd',
			12: 'bbbbbbbbbbb',
			14: '88888888888',
			16: '44444444444',
			18: '00000000000'
		},

		8: {
			length: 24,

			0:  '00000000000',
			2:  'fffffffffff',
			4:  'bbbbbbbbbbb',
			6:  '88888888888',
			8:  '66666666666',
			10: '44444444444',
			12: '22222222222',
			14: '00000000000',
			20: 'fffffffffff',
			22: 'bbbbbbbbbbb',
			23: '88888888888'
		},

		9: {
			length: 23,

			0:  'ff0000000f0',
			2:  'ff000000f00',
			4:  'ff0000000f0',
			6:  'ff000000f00',
			8:  '00f000000f0',
			10: '00f00000f00',
			12: '00f0000f000',
			13: '000ff00f000',
			14: '000ff000f00',
			16: '000ff00f000',
			18: '00f00000f00',
			20: '00f0000f000',
			22: '00f00000f00'
		},

		10: {
			length: 40,

			0:  '00000000000',
			14: 'f0000000000',
			18: '0f000000000',
			22: '00f00000000',
			27: '000f0000000',
			33: '0000f000000'
		},

		11: {
			length: 24,

			8:  'fffffffffff',
			20: '00000000000',
		},

		12: {
			length: 24,

			8:  'ffffff00000',
			20: '000000fffff',
		},

		12.5: {
			length: 24,

			8:  'ffffff00000',
			20: '0000f0fffff',
			23: '000000fffff',
		},

		13: {
			length: 6,

			0:  '000000bbbbb',
			2:  '00000088888',
			4:  '00000044444',
			6:  '00000000000'
		},

		14: {
			length: 11,

			0:  '0000f000000',
			3:  '00000000000',
		},

		14.5: {
			length: 11,

			0:  '0000ff00000',
			3:  '00000c00000',
			6:  '00000800000',
			9:  '00000300000',
		},

		15: {
			length: 96,

			0:  'f000f000000',
			3:  '00000000000',
			7:  '00000000f00',
			10: '00000000000',
			12: '0000f00f000',
			15: '00000000000',
			24: '00f0f000000',
			27: '00000000000',
			36: '0000f000000',
			39: '00000000000',
			48: '0000f0000f0',
			51: '00000000000',
			55: '00f00000000',
			58: '00000000000',
			60: '0000f000f00',
			63: '00000000000',
			72: '000ff000000',
			75: '00000000000',
			84: '0000f000000',
			87: '00000000000',
		},

		16: {
			length: 84,

			0:  '0000f00f000',
			3:  '00000000000',
			7:  '00f00000000',
			10: '00000000000',
			12: '0000f000f00',
			15: '00000000000',
			24: 'f000f000000',
			27: '00000000000',
			36: '00f0f000000',
			39: '00000000000',
			48: '0000f0000f0',
			51: '00000000000',
			60: '0f00f000000',
			63: '00000000000',
			72: '0000fa0f000',
			75: '00000800000',
			78: '00000600000',
			81: '00000300000',
		},

		16.5: {
			length: 84,

			0:  '0000f00f000',
			3:  '00000000000',
			7:  '00f00000000',
			10: '00000000000',
			12: '0000f000f00',
			15: '00000000000',
			24: 'f000f000000',
			27: '00000000000',
			36: '00f0f000000',
			39: '00000000000',
			48: '0000f0000f0',
			51: '00000000000',
			60: '0f00f000000',
			63: '00000000000',
			72: '0000ff0f000',
			75: '00000c00000',
			78: '00000800000',
			81: '00000300000',
		},

		17: {
			length: 12,

			0:  '0000f000000',
			3:  '00000000000',
		},

		18: {
			length: 96,

			0:  'f0000000000',
			3:  '00000000000',
			12: '0000000f000',
			15: '00000000000',
			24: '00f00000000',
			27: '00000000000',
			36: '00000f00000',
			39: '00000000000',
			48: '00f000000f0',
			51: '00000000000',
			60: '0000f000f00',
			63: '00000000000',
			72: '000f000f000',
			75: '00000000000',
			84: '0f00000000f',
			87: '00000000000',
		},

		18.5: {
			length: 96,

			0:  'f0000000000',
			3:  '00000000000',
			6:  '0000f000000',
			9:  '00000000000',
			12: '0000000f000',
			15: '00000000000',
			18: '0f000000000',
			21: '00000000000',
			24: '00f00000000',
			27: '00000000000',
			30: '0000000f000',
			33: '00000000000',
			36: '00000f00000',
			39: '00000000000',
			42: '0000f000000',
			45: '00000000000',
			48: '00f000000f0',
			51: '00000000000',
			54: '0000000f000',
			57: '00000000000',
			60: '0000f000f00',
			63: '00000000000',
			66: 'f0000000000',
			69: '00000000000',
			72: '000f0000f00',
			75: '00000000000',
			78: '00000f00000',
			81: '00000000000',
			84: '0f00000000f',
			87: '00000000000',
			90: '000f0000000',
			93: '00000000000',
			96: '0000000f000',
		},

		19: {
			length: 44,

			0:  'f00000fffff',
			2:  'c00000bbbbb',
			4:  'b0000088888',
			6:  '9000f0fffff',
			8:  '5000a0ccccc',
			10: '200000aaaaa',
			12: '0f000088888',
			14: '0c000066666',
			16: '0b000044444',
			18: '0900f0fffff',
			20: '0500a0bbbbb',
			22: '02000088888',
			24: '00f000fffff',
			26: '00c000bbbbb',
			28: '00b0f088888',
			30: '0090a0fffff',
			32: '005000ccccc',
			34: '002000aaaaa',
			36: '000f0088888',
			38: '000c0066666',
			40: '000bf044444',
			42: '0009a0fffff',
			44: '000500bbbbb',
		},

		19.5: {
			length: 48,

			0:  '000000ccccc',
			2:  'f00000fffff',
			4:  'a00000bbbbb',
			6:  '7000f088888',
			8:  '5000a0fffff',
			10: '200000ccccc',
			12: '0f0000aaaaa',
			14: '0c000088888',
			16: '0a000066666',
			18: '0700f044444',
			20: '0500a0fffff',
			22: '020000bbbbb',
			23: '00f00088888',
			24: '00c000ccccc',
			26: '00a000fffff',
			28: '008000bbbbb',
			30: '0060f088888',
			32: '0040a0fffff',
			34: '002000ccccc',
			36: '000f00aaaaa',
			38: '000c0088888',
			40: '000a0066666',
			42: '0008f044444',
			44: '0006a0fffff',
			46: '000400bbbbb',
			47: '00020088888'
		},

		20: {
			length: 48,

			0:  '000000ccccc',
			2:  'f00000fffff f',
			4:  'a00000bbbbb a',
			6:  '7000f088888 7',
			8:  '5000a0fffff 5',
			10: '200000ccccc 2',
			12: '0f0000aaaaa 0f',
			14: '0c000088888 0c',
			16: '0a000066666 0a',
			18: '0700f044444 07',
			20: '0500a0fffff 05',
			22: '020000bbbbb 02',
			23: '00f00088888 00f',
			24: '00c000ccccc 00c',
			26: '00a000fffff 00a',
			28: '008000bbbbb 008',
			30: '0060f088888 006',
			32: '0040a0fffff 004',
			34: '002000ccccc 002',
			36: '000f00aaaaa 000f',
			38: '000c0088888 000c',
			40: '000a0066666 000a',
			42: '0008f044444 0008',
			44: '0006a0fffff 0006',
			46: '000400bbbbb 0004',
			47: '00020088888 0002',
		},

		20.1: {
			length: 48,

			0:  '000000ccccc 0000',
			2:  'f00000fffff 0000f',
			4:  'a00000bbbbb 0000a',
			6:  '7000f088888 00007',
			8:  '5000a0fffff 00005',
			10: '200000ccccc 00002',
			12: '0f0000aaaaa 00000f',
			14: '0c000088888 00000c',
			16: '0a000066666 00000a',
			18: '0700f044444 000007',
			20: '0500a0fffff 000005',
			22: '020000bbbbb 000002',
			23: '00f00088888 000000f',
			24: '00c000ccccc 000000c',
			26: '00a000fffff 000000a',
			28: '008000bbbbb 0000008',
			30: '0060f088888 0000006',
			32: '0040a0fffff 0000004',
			34: '002000ccccc 0000002',
			36: '000f00aaaaa 0000000f',
			38: '000c0088888 0000000c',
			40: '000a0066666 0000000a',
			42: '0008f044444 00000008',
			44: '0006a0fffff 00000006',
			46: '000400bbbbb 00000004',
			47: '00020088888 00000002',
		},

		20.2: {
			length: 48,

			0:  '000000ccccc 00000000',
			2:  'f00000fffff 00000000f',
			4:  'a00000bbbbb 00000000a',
			6:  '7000f088888 000000007',
			8:  '5000a0fffff 000000005',
			10: '200000ccccc 000000002',
			12: '0f0000aaaaa 000000000f',
			14: '0c000088888 000000000c',
			16: '0a000066666 000000000a',
			18: '0700f044444 0000000007',
			20: '0500a0fffff 0000000005',
			22: '020000bbbbb 0000000002',
			23: '00f00088888 0000000000f',
			24: '00c000ccccc 0000000000c',
			26: '00a000fffff 0000000000a',
			28: '008000bbbbb 00000000008',
			30: '0060f088888 00000000006',
			32: '0040a0fffff 00000000004',
			34: '002000ccccc 00000000002',
			36: '000f00aaaaa 00000000000f',
			38: '000c0088888 00000000000c',
			40: '000a0066666 00000000000a',
			42: '0008f044444 000000000008',
			44: '0006a0fffff 000000000006',
			46: '000400bbbbb 000000000004',
			47: '00020088888 000000000002',
		},

		20.3: {
			length: 48,

			0:  '000000ccccc 000000000000',
			2:  'f00000fffff 000000000000f',
			4:  'a00000bbbbb 000000000000a',
			6:  '7000f088888 0000000000007',
			8:  '5000a0fffff 0000000000005',
			10: '200000ccccc 0000000000002',
			12: '0f0000aaaaa 0000000000000f',
			14: '0c000088888 0000000000000c',
			16: '0a000066666 0000000000000a',
			18: '0700f044444 00000000000007',
			20: '0500a0fffff 00000000000005',
			22: '020000bbbbb 00000000000002',
			23: '00f00088888 00000000000000f',
			24: '00c000ccccc 00000000000000c',
			26: '00a000fffff 00000000000000a',
			28: '008000bbbbb 000000000000008',
			30: '0060f088888 000000000000006',
			32: '0040a0fffff 000000000000004',
			34: '002000ccccc 000000000000002',
			36: '000f00aaaaa 000000000000000f',
			38: '000c0088888 000000000000000c',
			40: '000a0066666 000000000000000a',
			42: '0008f044444 0000000000000008',
			44: '0006a0fffff 0000000000000006',
			46: '000400bbbbb 0000000000000004',
			47: '00020088888 0000000000000002',
		},

		20.4: {
			length: 48,

			0:  '000000ccccc 0000000000000000',
			2:  'f00000fffff 0000000000000000f',
			4:  'a00000bbbbb 0000000000000000a',
			6:  '7000f088888 00000000000000007',
			8:  '5000a0fffff 00000000000000005',
			10: '200000ccccc 00000000000000002',
			12: '0f0000aaaaa 00000000000000000f',
			14: '0c000088888 00000000000000000c',
			16: '0a000066666 00000000000000000a',
			18: '0700f044444 000000000000000007',
			20: '0500a0fffff 000000000000000005',
			22: '020000bbbbb 000000000000000002',
			23: '00f00088888 000000000000000000f',
			24: '00c000ccccc 000000000000000000c',
			26: '00a000fffff 000000000000000000a',
			28: '008000bbbbb 0000000000000000008',
			30: '0060f088888 0000000000000000006',
			32: '0040a0fffff 0000000000000000004',
			34: '002000ccccc 0000000000000000002',
			36: '000f00aaaaa 0000000000000000000f',
			38: '000c0088888 0000000000000000000c',
			40: '000a0066666 0000000000000000000a',
			42: '0008f044444 00000000000000000008',
			44: '0006a0fffff 00000000000000000006',
			46: '000400bbbbb 00000000000000000004',
			47: '00020088888 00000000000000000002',
		},

		20.5: {
			length: 48,

			0:  '000000ccccc 00000000000000000000',
			2:  'f00000fffff 00000000000000000000f',
			4:  'a00000bbbbb 00000000000000000000a',
			6:  '7000f088888 000000000000000000007',
			8:  '5000a0fffff 000000000000000000005',
			10: '200000ccccc 000000000000000000002',
			12: '0f0000aaaaa 000000000000000000000f',
			14: '0c000088888 000000000000000000000c',
			16: '0a000066666 000000000000000000000a',
			18: '0700f044444 0000000000000000000007',
			20: '0500a0fffff 0000000000000000000005',
			22: '020000bbbbb 0000000000000000000002',
			23: '00f00088888 0000000000000000000000f',
			24: '00c000ccccc 0000000000000000000000c',
			26: '00a000fffff 0000000000000000000000a',
			28: '008000bbbbb 00000000000000000000008',
			30: '0060f088888 00000000000000000000006',
			32: '0040a0fffff 00000000000000000000004',
			34: '002000ccccc 00000000000000000000002',
			36: '000f00aaaaa 00000000000000000000000f',
			38: '000c0088888 00000000000000000000000c',
			40: '000a0066666 00000000000000000000000a',
			42: '0008f044444 000000000000000000000008',
			44: '0006a0fffff 000000000000000000000006',
			46: '000400bbbbb 000000000000000000000004',
			47: '00020088888 000000000000000000000002',
		},


	},

	sequence  = [
		// intro
		0, 0.5, 0.6, 0.6, 0.6, 0.6,
		1, 2,
		0.6, 0.6, 0.6, 0.6, 0.6, 0.6,
		1, 3,

		// drums - "chorus"
		4, 4, 4, 4, 4, 4,
		1, 2,
		4, 4, 4, 4, 4, 4,

		// transition
		1, 5,
		1, 5,
		8, 8, 1, 6, 7,

		// drums and guitar/violin - "chorus"
		9, 9, 9, 9, 9, 9,
		1, 2,
		9, 9, 9, 9, 9, 9,

		// transition
		1, 10,
		1, 10,
		8, 8, 1, 11, 12, 12, 12.5, 13,

		// build up
		14, 14, 14, 14, 14,
		14, 14, 14, 14, 14,
		14, 14, 14, 14, 14.5,
		14,

		// cool part
		15, 16, 17, 15, 16.5,

		// transition
		1, 5,
		1, 5,
		8, 8, 1, 6, 7,

		// drums and guitar/violin - "chorus"
		9, 9, 9, 9, 9, 9,
		1, 2,
		9, 9, 9, 9, 9, 9,
		1, 5,
		1, 5,

		// transition
		1, 5,
		18, 18.5,
		
		19, 19.5, 19.5, 19.5,
		20, 20.1, 20.2, 20.3, 20.4, 20.5,

		20, 20.1, 20.2, 20.3, 20.4, 20.5,

		1, 5,
		1, 5,
		8, 8, 1, 6, 7,

		// drums and guitar/violin - "chorus"
		9, 9, 9, 9, 9, 9,
		1, 2,
		9, 9, 9, 9, 9, 9,

	],

	frame     = {},

	render    = function(tick) {
		if (!audio.seeking && (audio.paused || audio.ended))
			return;

		var n = audio.duration > 52 ? 4.5 : .3;

		if (audio.currentTime < audio.duration - n) {
			if (credits.style.display != 'none')
				credits.style.display = 'none';
		} else if (credits.style.display != 'block') {
			credits.style.display = 'block';
		}

		while (!frame[tick] && tick > 0)
			tick--;

		if (frame[tick]) {
			for (var c, i=0; i<frame[tick].length; i++) {
				c = '#' + frame[tick][i] + '00';

				if (block[i].style.color != c)
					block[i].style.color = c;
			}
		}
	};

window.onload = function() {
	document.body.appendChild(container);

	for (var s, j=0, i=0; i<=42; i++, j++) {
		s = document.createElement('span');

		if (i == 11) {
			container.appendChild(document.createElement('br'));
			j = 0;
		}

		if (i < 11) {
			s.innerHTML = message.title.charAt(j);
			s.className = 'title';
		} else {
			if (message.text.charAt(j) == ' ') {
				j++;
				s.innerHTML = '&nbsp;';
			}

			s.innerHTML += message.text.charAt(j);
		}

		container.appendChild(s);
		block[block.length] = s;
	}

	var index = 0, prev = 'fffffffffffffffffffffffffffffffffff', cur;
	for (i in sequence) {
		if (!pattern[sequence[i]])
			continue;

		for (j in pattern[sequence[i]]) {
			if (j == 'length')
				continue;

			cur = (pattern[sequence[i]][j].replace(' ', ''));
			frame[parseInt(j) + index] = prev = cur + prev.substr(cur.length);
		}

		index += pattern[sequence[i]].length + 1;
	}

	document.body.appendChild(credits);
	credits.style.display = 'none';
	credits.innerHTML     = '<div>'
	                      + '<span class="title">html5, ftw.</span><br>'
	                      + '<span>song: TSO - Wizards in Winter</span><br>'
	                      + '<span>syncing thanks to the html5 &lt;audio&gt; tag</span><br>'
	                      + '<span style="font-size: 12px;">(with apologies to YouFail.org)</span><br>'
	                      + '</div>';
	
	var	ogg  = document.createElement('source'),
		mp3  = document.createElement('source'),
		file = (location.search.match(/[?&]file=([a-z-]+)/) || ['']).pop();
		fps  = Math.max(5, Math.min(60, parseInt((location.search.match(/[?&]fps=(\d+(?:\.\d+)?)/) || [30]).pop(), 10)));

	ogg.src  = file ? file + '.ogg' : 'wizards-30.ogg';
	ogg.type = 'audio/ogg';

	mp3.src  = file ? file + '.m4a' : 'wizards-30.mp3';
	mp3.type = 'audio/mpeg';

	audio.appendChild(mp3);
	audio.appendChild(ogg);

	document.body.appendChild(audio);

	//audio.autoplay        = true;
	audio.controls        = /[?&]controls(=(1|true|yes|on))?/.test(location.search);

	(function() {
		if (audio.readyState != 4)
			return setTimeout(arguments.callee, 10);

		audio.play();
		audio.currentTime  = parseFloat((location.search.match(/[?&]time=(\d+(?:\.\d+)?)/) || [0]).pop(), 10);
		audio.playbackRate = Math.max(0.5, Math.min(4, parseFloat((location.search.match(/[?&]rate=(\d+(?:\.\d+)?)/) || [1]).pop(), 10)));
	})();

	if (/[?&]metronome(=(1|true|yes|on))?/.test(location.search))
		document.body.appendChild(metronome);

	render(0);

	(function() {
		var frame, tick, beat, last, swatch;
		setInterval(function() {
			if (audio.paused) return;

			frame = Math.floor(audio.currentTime * 30);
			render(frame);

			tick  = ((frame % (30 / (bpm / 60))) - offset);
			beat  = tick < 4 && tick > 0;

			if (beat != last) {
				last = beat;
				if (beat) swatch = !swatch;
				metronome.className = beat ? 'beat' : '';
			}

			metronome.innerHTML = '<span>' + (beat ? '|' : swatch ? '/' : '\\' ) + '</span><span>' + frame + '</span>';
		}, 1000 / fps);
	})();
};
